name: Deploy
on:
  push:
    branches: [ "main" ]  # change if you deploy from another branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (for building)
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install & build
        run: |
          npm ci
          npm run build || true

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_KEY }}

      - name: Trust host
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "${{ vars.SSH_PORT }}" "${{ vars.SSH_HOST }}" >> ~/.ssh/known_hosts

      - name: Rsync code to server
        run: |
          rsync -az --delete -e "ssh -p ${ { vars.SSH_PORT } }" \
            --exclude-from ".rsyncignore" \
            ./ "${{ vars.SSH_USER }}@${{ vars.SSH_HOST }}:${{ vars.APP_DIR }}/"

      - name: Install deps & reload pm2 on server
        run: |
          ssh -p "${{ vars.SSH_PORT }}" "${{ vars.SSH_USER }}@${{ vars.SSH_HOST }}" << 'EOF'
            set -e
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            APP_DIR="${APP_DIR:-/home/deploy/apps/eras-zombie}"
            cd "$APP_DIR"
            if command -v npm >/dev/null 2>&1; then
              npm ci --omit=dev || npm install --production
            fi
            if command -v pm2 >/dev/null 2>&1; then
              pm2 reload ecosystem.config.js || pm2 start ecosystem.config.js
              pm2 save
            else
              npm i -g pm2
              pm2 start ecosystem.config.js
              pm2 save
            fi
          EOF
        env:
          APP_DIR: ${{ vars.APP_DIR }}
